<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= typeof title !== 'undefined' ? title : 'Products' %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .filter-chip { font-size: .85rem; }
    .price-inputs input { max-width: 120px; }
  </style>
</head>
<body>
  <%- include('../partials/header') %>

  <main class="container py-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Products</li>
      </ol>
    </nav>

    <div class="row g-4">
      <!-- Sidebar Filters (desktop) -->
      <aside class="col-lg-3 d-none d-lg-block">
        <form method="GET" action="/products" class="vstack gap-3">
          <div>
            <label class="form-label">Search</label>
            <div class="input-group input-group-sm">
              <input type="search" name="q" class="form-control" placeholder="Search products" value="<%= (query && query.q) || '' %>">
              <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
              <a class="btn btn-outline-danger" href="/products"><i class="bi bi-x-circle"></i></a>
            </div>
          </div>

          <div>
            <label class="form-label">Sort</label>
            <select class="form-select form-select-sm" name="sort" onchange="this.form.submit()">
              <option value="">Default</option>
              <option value="price_asc" <%= (query && query.sort === 'price_asc') ? 'selected' : '' %>>Price: low to high</option>
              <option value="price_desc" <%= (query && query.sort === 'price_desc') ? 'selected' : '' %>>Price: high to low</option>
              <option value="name_asc" <%= (query && query.sort === 'name_asc') ? 'selected' : '' %>>aA - zZ</option>
              <option value="name_desc" <%= (query && query.sort === 'name_desc') ? 'selected' : '' %>>zZ - aA</option>
              <option value="new_arrivals" <%= (query && query.sort === 'new_arrivals') ? 'selected' : '' %>>New arrivals</option>
              <option value="featured" <%= (query && query.sort === 'featured') ? 'selected' : '' %>>Featured</option>
              <option value="popularity" <%= (query && query.sort === 'popularity') ? 'selected' : '' %>>Popularity</option>
              <option value="rating" <%= (query && query.sort === 'rating') ? 'selected' : '' %>>Average ratings</option>
            </select>
          </div>

          <div>
            <label class="form-label">Category</label>
            <div class="vstack gap-2">
              <% const categories = (filters && filters.categories) || [ 'Chronograph', 'Diver', 'Minimal', 'Aviator' ]; %>
              <% const selCats = (query && query.category) ? (Array.isArray(query.category) ? query.category : [query.category]) : []; %>
              <% categories.forEach(cat => { %>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="category" value="<%= cat %>" id="cat-<%= cat %>" <%= selCats.includes(cat) ? 'checked' : '' %>>
                  <label class="form-check-label" for="cat-<%= cat %>"><%= cat %></label>
                </div>
              <% }) %>
            </div>
          </div>

          <div>
            <label class="form-label">Brand</label>
            <div class="vstack gap-2">
              <% const brands = (filters && filters.brands) || [ 'Omega', 'Rolex', 'Seiko', 'Casio' ]; %>
              <% const selBrands = (query && query.brand) ? (Array.isArray(query.brand) ? query.brand : [query.brand]) : []; %>
              <% brands.forEach(b => { %>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="brand" value="<%= b %>" id="brand-<%= b %>" <%= selBrands.includes(b) ? 'checked' : '' %>>
                  <label class="form-check-label" for="brand-<%= b %>"><%= b %></label>
                </div>
              <% }) %>
            </div>
          </div>

          <div>
            <label class="form-label">Price Range</label>
            <div class="d-flex align-items-center gap-2 price-inputs">
              <input type="number" step="0.01" class="form-control form-control-sm" name="minPrice" placeholder="Min" value="<%= (query && query.minPrice) || '' %>">
              <span class="text-muted">–</span>
              <input type="number" step="0.01" class="form-control form-control-sm" name="maxPrice" placeholder="Max" value="<%= (query && query.maxPrice) || '' %>">
            </div>
          </div>

          <button class="btn btn-dark btn-sm" type="submit">Apply Filters</button>
        </form>
      </aside>

      <!-- Main content -->
      <section class="col-lg-9">
        <!-- Mobile toolbar -->
        <div class="d-lg-none d-flex justify-content-between align-items-center mb-3">
          <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="offcanvas" data-bs-target="#mobileFilters">
            <i class="bi bi-sliders"></i> Filters
          </button>
          <form method="GET" action="/products" class="d-flex gap-2 w-75">
            <input type="search" name="q" class="form-control form-control-sm" placeholder="Search" value="<%= (query && query.q) || '' %>">
            <select class="form-select form-select-sm" name="sort">
              <option value="">Sort</option>
              <option value="price_asc" <%= (query && query.sort === 'price_asc') ? 'selected' : '' %>>Price: low to high</option>
              <option value="price_desc" <%= (query && query.sort === 'price_desc') ? 'selected' : '' %>>Price: high to low</option>
              <option value="name_asc" <%= (query && query.sort === 'name_asc') ? 'selected' : '' %>>aA - zZ</option>
              <option value="name_desc" <%= (query && query.sort === 'name_desc') ? 'selected' : '' %>>zZ - aA</option>
              <option value="new_arrivals" <%= (query && query.sort === 'new_arrivals') ? 'selected' : '' %>>New arrivals</option>
              <option value="featured" <%= (query && query.sort === 'featured') ? 'selected' : '' %>>Featured</option>
              <option value="popularity" <%= (query && query.sort === 'popularity') ? 'selected' : '' %>>Popularity</option>
              <option value="rating" <%= (query && query.sort === 'rating') ? 'selected' : '' %>>Average ratings</option>
            </select>
            <button class="btn btn-outline-secondary btn-sm" type="submit"><i class="bi bi-search"></i></button>
          </form>
        </div>

        <!-- Active filter chips -->
        <div class="mb-3">
          <% const chips = []; %>
          <% if (query && query.q) { chips.push({label: `Search: ${query.q}`}); } %>
          <% (selCats || []).forEach(c => chips.push({label: c})); %>
          <% (selBrands || []).forEach(b => chips.push({label: b})); %>
          <% if (query && (query.minPrice || query.maxPrice)) { chips.push({label: `Price: ${query.minPrice || 0} – ${query.maxPrice || '∞'}`}); } %>
          <% if (chips.length) { %>
            <div class="d-flex flex-wrap gap-2">
              <% chips.forEach(ch => { %>
                <span class="badge text-bg-light border filter-chip"><%= ch.label %></span>
              <% }) %>
              <a class="btn btn-outline-danger btn-sm" href="/products">Clear All</a>
            </div>
          <% } %>
        </div>

        <!-- Products grid -->
        <div class="row g-3">
          <% const items = (typeof products !== 'undefined') ? products : [
            { _id: 1, name: 'Classic Chronograph', price: 299.99, imageUrl: 'https://placehold.co/600x600', isDeleted: false, stock: 10 },
            { _id: 2, name: 'Modern Minimal', price: 349.99, imageUrl: 'https://placehold.co/600x600', isDeleted: false, stock: 0 },
            { _id: 3, name: 'Diver Elite', price: 450.00, imageUrl: 'https://placehold.co/600x600', isDeleted: false, stock: 22 },
            { _id: 4, name: 'Aviator Pro', price: 399.99, imageUrl: 'https://placehold.co/600x600', isDeleted: true, stock: 18 },
          ]; %>
          <% items.filter(p => !p.isDeleted).forEach(product => { %>
            <div class="col-6 col-md-4 col-lg-3">
              <%- include('../partials/product-card', { product }) %>
            </div>
          <% }) %>
          <% if (!items.filter(p => !p.isDeleted).length) { %>
            <div class="col-12">
              <div class="alert alert-warning">No products found. Try adjusting your filters.</div>
            </div>
          <% } %>
        </div>

        <!-- Pagination (backend should provide totalPages, current page) -->
        <nav class="mt-4" aria-label="Products pagination">
          <% const pg = (typeof pagination !== 'undefined') ? pagination : { page: 1, totalPages: 3 }; %>
          <% if (pg.totalPages > 1) { %>
            <ul class="pagination justify-content-end">
              <li class="page-item <%= pg.page <= 1 ? 'disabled' : '' %>">
                <a class="page-link" href="?<%= new URLSearchParams({ ...query, page: Math.max(1, pg.page - 1) }).toString() %>">Prev</a>
              </li>
              <% for (let i = 1; i <= pg.totalPages; i++) { %>
                <li class="page-item <%= i === pg.page ? 'active' : '' %>">
                  <a class="page-link" href="?<%= new URLSearchParams({ ...query, page: i }).toString() %>"><%= i %></a>
                </li>
              <% } %>
              <li class="page-item <%= pg.page >= pg.totalPages ? 'disabled' : '' %>">
                <a class="page-link" href="?<%= new URLSearchParams({ ...query, page: Math.min(pg.totalPages, pg.page + 1) }).toString() %>">Next</a>
              </li>
            </ul>
          <% } %>
        </nav>
      </section>
    </div>
  </main>

  <!-- Mobile offcanvas filters -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileFilters">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Filters</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <form method="GET" action="/products" class="vstack gap-3">
        <div>
          <label class="form-label">Search</label>
          <input type="search" name="q" class="form-control" placeholder="Search products" value="<%= (query && query.q) || '' %>">
        </div>
        <div>
          <label class="form-label">Sort</label>
          <select class="form-select" name="sort">
            <option value="">Default</option>
            <option value="price_asc" <%= (query && query.sort === 'price_asc') ? 'selected' : '' %>>Price: low to high</option>
            <option value="price_desc" <%= (query && query.sort === 'price_desc') ? 'selected' : '' %>>Price: high to low</option>
            <option value="name_asc" <%= (query && query.sort === 'name_asc') ? 'selected' : '' %>>aA - zZ</option>
            <option value="name_desc" <%= (query && query.sort === 'name_desc') ? 'selected' : '' %>>zZ - aA</option>
            <option value="new_arrivals" <%= (query && query.sort === 'new_arrivals') ? 'selected' : '' %>>New arrivals</option>
            <option value="featured" <%= (query && query.sort === 'featured') ? 'selected' : '' %>>Featured</option>
            <option value="popularity" <%= (query && query.sort === 'popularity') ? 'selected' : '' %>>Popularity</option>
            <option value="rating" <%= (query && query.sort === 'rating') ? 'selected' : '' %>>Average ratings</option>
          </select>
        </div>
        <div>
          <label class="form-label">Category</label>
          <div class="vstack gap-2">
            <% (categories || [ 'Chronograph', 'Diver', 'Minimal', 'Aviator' ]).forEach(cat => { const checked = (selCats||[]).includes(cat); %>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="category" value="<%= cat %>" id="m-cat-<%= cat %>" <%= checked ? 'checked' : '' %>>
                <label class="form-check-label" for="m-cat-<%= cat %>"><%= cat %></label>
              </div>
            <% }); %>
          </div>
        </div>
        <div>
          <label class="form-label">Brand</label>
          <div class="vstack gap-2">
            <% (brands || [ 'Omega', 'Rolex', 'Seiko', 'Casio' ]).forEach(b => { const checked = (selBrands||[]).includes(b); %>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="brand" value="<%= b %>" id="m-brand-<%= b %>" <%= checked ? 'checked' : '' %>>
                <label class="form-check-label" for="m-brand-<%= b %>"><%= b %></label>
              </div>
            <% }); %>
          </div>
        </div>
        <div>
          <label class="form-label">Price Range</label>
          <div class="d-flex align-items-center gap-2">
            <input type="number" step="0.01" class="form-control" name="minPrice" placeholder="Min" value="<%= (query && query.minPrice) || '' %>">
            <span class="text-muted">–</span>
            <input type="number" step="0.01" class="form-control" name="maxPrice" placeholder="Max" value="<%= (query && query.maxPrice) || '' %>">
          </div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-dark w-100" type="submit">Apply</button>
          <a class="btn btn-outline-danger w-100" href="/products">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <%- include('../partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
