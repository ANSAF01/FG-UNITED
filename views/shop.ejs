<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/header') %>

  <main class="container py-4">
    <!-- Page Header -->
    <div class="row mb-4">
      <div class="col-12">
        <h1 class="h3 mb-2 text-center">Shop</h1>
        <p class="text-muted text-center">Discover our collection of premium watches</p>
      </div>
    </div>

    <div class="row">
      <!-- Filters Sidebar -->
      <div class="col-lg-3 mb-4">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h5>
          </div>
          <div class="card-body">
            <form method="GET" action="/shop">
              <!-- Search -->
              <div class="mb-3">
                <label class="form-label">Search</label>
                <input type="text" class="form-control" name="q" value="<%= query.q || '' %>" placeholder="Search watches...">
              </div>

              <!-- Categories -->
              <div class="mb-3">
                <label class="form-label">Categories</label>
                <% filters.categories.forEach(cat => { %>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="category" value="<%= cat %>" 
                           <%= (query.category && (Array.isArray(query.category) ? query.category.includes(cat) : query.category === cat)) ? 'checked' : '' %>>
                    <label class="form-check-label"><%= cat %></label>
                  </div>
                <% }) %>
              </div>

              <!-- Brands -->
              <div class="mb-3">
                <label class="form-label">Brands</label>
                <% filters.brands.forEach(brand => { %>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="brand" value="<%= brand %>" 
                           <%= (query.brand && (Array.isArray(query.brand) ? query.brand.includes(brand) : query.brand === brand)) ? 'checked' : '' %>>
                    <label class="form-check-label"><%= brand %></label>
                  </div>
                <% }) %>
              </div>

              <!-- Price Range -->
              <div class="mb-3">
                <label class="form-label">Price Range</label>
                <div class="row g-2">
                  <div class="col-6">
                    <input type="number" class="form-control" name="minPrice" value="<%= query.minPrice || '' %>" placeholder="Min">
                  </div>
                  <div class="col-6">
                    <input type="number" class="form-control" name="maxPrice" value="<%= query.maxPrice || '' %>" placeholder="Max">
                  </div>
                </div>
              </div>

              <!-- Filter Buttons -->
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
                <a href="/shop" class="btn btn-outline-secondary">Clear All</a>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Products Section -->
      <div class="col-lg-9">
        <!-- Sort and Results Info -->
        <div class="row mb-3 align-items-center">
          <div class="col-md-6">
            <p class="mb-0 text-muted">
              Showing <%= products.length %> of <%= pagination.total %> results
              <% if (query.q) { %> for "<%= query.q %>"<% } %>
            </p>
          </div>
          <div class="col-md-6">
            <form method="GET" action="/shop" class="d-flex justify-content-end">
              <!-- Preserve existing filters -->
              <% if (query.q) { %><input type="hidden" name="q" value="<%= query.q %>"><% } %>
              <% if (query.category) { 
                const cats = Array.isArray(query.category) ? query.category : [query.category];
                cats.forEach(cat => { %>
                  <input type="hidden" name="category" value="<%= cat %>">
                <% }); } %>
              <% if (query.brand) { 
                const brands = Array.isArray(query.brand) ? query.brand : [query.brand];
                brands.forEach(brand => { %>
                  <input type="hidden" name="brand" value="<%= brand %>">
                <% }); } %>
              <% if (query.minPrice) { %><input type="hidden" name="minPrice" value="<%= query.minPrice %>"><% } %>
              <% if (query.maxPrice) { %><input type="hidden" name="maxPrice" value="<%= query.maxPrice %>"><% } %>
              
              <select name="sort" class="form-select" style="width: auto;" onchange="this.form.submit()">
                <option value="">Sort by</option>
                <option value="name_asc" <%= query.sort === 'name_asc' ? 'selected' : '' %>>Name A-Z</option>
                <option value="name_desc" <%= query.sort === 'name_desc' ? 'selected' : '' %>>Name Z-A</option>
                <option value="price_asc" <%= query.sort === 'price_asc' ? 'selected' : '' %>>Price Low-High</option>
                <option value="price_desc" <%= query.sort === 'price_desc' ? 'selected' : '' %>>Price High-Low</option>
                <option value="rating" <%= query.sort === 'rating' ? 'selected' : '' %>>Highest Rated</option>
                <option value="new_arrivals" <%= query.sort === 'new_arrivals' ? 'selected' : '' %>>New Arrivals</option>
              </select>
            </form>
          </div>
        </div>

        <!-- Products Grid -->
        <div class="row g-4">
          <% if (products.length > 0) { %>
            <% products.forEach(product => { %>
              <div class="col-6 col-md-4 col-xl-3">
                <%- include('partials/product-card', { product }) %>
              </div>
            <% }) %>
          <% } else { %>
            <div class="col-12">
              <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4>No products found</h4>
                <p class="text-muted">Try adjusting your filters or search terms</p>
                <a href="/shop" class="btn btn-primary">View All Products</a>
              </div>
            </div>
          <% } %>
        </div>

        <!-- Pagination -->
        <% if (pagination.totalPages > 1) { %>
          <nav aria-label="Product pagination" class="mt-5">
            <ul class="pagination justify-content-center">
              <!-- Previous Page -->
              <li class="page-item <%= pagination.page <= 1 ? 'disabled' : '' %>">
                <a class="page-link" href="?<%= new URLSearchParams({...query, page: pagination.page - 1}).toString() %>">
                  <i class="fas fa-chevron-left"></i>
                </a>
              </li>

              <!-- Page Numbers -->
              <% 
                const startPage = Math.max(1, pagination.page - 2);
                const endPage = Math.min(pagination.totalPages, pagination.page + 2);
                
                if (startPage > 1) { %>
                  <li class="page-item">
                    <a class="page-link" href="?<%= new URLSearchParams({...query, page: 1}).toString() %>">1</a>
                  </li>
                  <% if (startPage > 2) { %>
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                  <% } %>
                <% }
                
                for (let i = startPage; i <= endPage; i++) { %>
                  <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
                    <a class="page-link" href="?<%= new URLSearchParams({...query, page: i}).toString() %>"><%= i %></a>
                  </li>
                <% }
                
                if (endPage < pagination.totalPages) { %>
                  <% if (endPage < pagination.totalPages - 1) { %>
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                  <% } %>
                  <li class="page-item">
                    <a class="page-link" href="?<%= new URLSearchParams({...query, page: pagination.totalPages}).toString() %>"><%= pagination.totalPages %></a>
                  </li>
                <% } %>

              <!-- Next Page -->
              <li class="page-item <%= pagination.page >= pagination.totalPages ? 'disabled' : '' %>">
                <a class="page-link" href="?<%= new URLSearchParams({...query, page: pagination.page + 1}).toString() %>">
                  <i class="fas fa-chevron-right"></i>
                </a>
              </li>
            </ul>
          </nav>
        <% } %>
      </div>
    </div>
  </main>

  <%- include('partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>